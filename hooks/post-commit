#!/bin/zsh
#
# Post-commit hook: Auto-sync template repo when cursor-starter-kit changes
#
# This hook runs after each commit and checks if files in cursor-starter-kit/
# were changed. If so, it automatically syncs the template repository.

# Get the last commit
LAST_COMMIT=$(git rev-parse HEAD)

# Get changed files in cursor-starter-kit/
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r "$LAST_COMMIT" | grep "^cursor-starter-kit/" || true)

# Check if any files in cursor-starter-kit/ were changed in this commit
if [ -n "$CHANGED_FILES" ]; then
    # Get the repo root
    REPO_ROOT="$(git rev-parse --show-toplevel)"
    SYNC_SCRIPT="$REPO_ROOT/cursor-starter-kit/sync-template.sh"
    
    # Check if sync script exists
    if [ -f "$SYNC_SCRIPT" ] && [ -x "$SYNC_SCRIPT" ]; then
        echo ""
        echo "ğŸ”„ cursor-starter-kit/ changed - syncing template repository..."
        cd "$REPO_ROOT/cursor-starter-kit"
        
        # Run sync (non-interactive, auto-commit)
        "$SYNC_SCRIPT" --yes 2>&1 | grep -v "^$" || {
            echo "âš ï¸  Template sync had issues (check manually if needed)"
        }
    else
        echo "âš ï¸  Sync script not found: $SYNC_SCRIPT"
    fi
    
    # Check if cursorkit.zsh was updated - remind user to update OMZ
    if echo "$CHANGED_FILES" | grep -q "cursor-starter-kit/cursorkit.zsh"; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ REMINDER: cursorkit.zsh was updated!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "   Update your local OMZ copy if needed:"
        echo "   cp cursor-starter-kit/cursorkit.zsh ~/.oh-my-zsh/custom/cursorkit.zsh"
        echo ""
        echo "   Or reload your shell: exec zsh"
        echo ""
    fi
fi

exit 0
